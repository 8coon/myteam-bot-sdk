import {MessageBuilder, MyTeamSDK} from 'myteam-bot-sdk';

// "–ú–æ–¥–µ–ª—å" –æ–ø—Ä–æ—Å–∞
interface Poll {
	// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–∑–¥–∞–≤—à–∏–π –æ–ø—Ä–æ—Å
	author: string;
	// –í–æ–ø—Ä–æ—Å –æ–ø—Ä–æ—Å–∞
	question: string;
	// –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
	options: { text: string, votes: number }[];
	// –°–ª–æ–≤–∞—Ä—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –¥–≤–∞–∂–¥—ã)
	usersVoted: Record<string, true>;
	// id —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–ø—Ä–æ—Å–æ–º
	messageId?: string;
}

// –¢—É—Ç —É–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SDK
const sdk = new MyTeamSDK({
	// –ù–∏–∫ –±–æ—Ç–∞: example.poll.bot
	// –î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ –≤–∞—à–µ–º –¥–æ–º–µ–Ω–µ MyTeam, —Å–æ–∑–¥–∞–π—Ç–µ —É —Å–µ–±—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ —Ç–æ–∫–µ–Ω —Å—é–¥–∞
	token: '' || process.env.EXAMPLE_TOKEN,

	// –¢—É—Ç –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å API –∏–º–µ–Ω–Ω–æ –≤–∞—à–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ MyTeam!
	// –ï—Å–ª–∏ –≤—ã –µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç–µ, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–≤–æ–µ–º—É —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
	baseURL: process.env.MYTEAM_API_URL,
});

// –ë—É–¥–µ–º –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–ø—Ä–æ—Å–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ id
let lastPollId = 0;
// –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ–ø—Ä–æ—Å–æ–≤
// –í —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª–µ / –ë–î / Firebase,
// –∏–Ω–∞—á–µ –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–µ–∫—É—â–∏–º –æ–ø—Ä–æ—Å–∞–º –±—É–¥—É—Ç —Ç–µ—Ä—è—Ç—å—Å—è
// –ù–æ —É –Ω–∞—Å –ø—Ä–∏–º–µ—Ä, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Ö—Ä–∞–Ω–∏–º –≤ –ø–∞–º—è—Ç–∏
const polls: Record<string, Poll | undefined> = {};

sdk.addCommand('/poll', async (ctx) => {
	// –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ä–µ–≥—É–ª—è—Ä–∫–æ–π
	// SDK –Ω–∏–∫–∞–∫ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫—Ä–æ–º–µ –æ–±—Ä–µ–∑–∞–Ω–∏—è –∏–º–µ–Ω–∏ –∫–æ–º–∞–Ω–¥—ã
	// –¢–∞–∫ —á—Ç–æ –¥–µ–ª–∞–µ–º —ç—Ç–æ —Ç—É—Ç
	const args: string[] = [...ctx.args.matchAll(/"(.+?)"/g)].map(_ => _[1]);
	const question = args.shift();

	// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å
	if (!question) {
		return ctx.sdk.sendText(ctx.event.payload.chat.chatId, '–í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ –≤–æ–ø—Ä–æ—Å –¥–ª—è –æ–ø—Ä–æ—Å–∞!');
	}

	// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–ª –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
	if (!args.length) {
		return ctx.sdk.sendText(ctx.event.payload.chat.chatId, '–í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞!');
	}

	// –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–ø—Ä–æ—Å –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
	const pollId = ++lastPollId;
	polls[pollId] = {
		author: ctx.event.payload.from.userId,
		question,
		// –í—ã—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –≥–æ–ª–æ—Å–∞ –≤ 0
		options: args.map((text) => ({
			text,
			votes: 0,
		})),
		// –ï—â—ë –Ω–∏–∫—Ç–æ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
		usersVoted: {},
	};

	// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞
	const message = new MessageBuilder()
		.text('üìä')
		.text(` [${pollId}] `)
		.formatText('bold', `–û–ø—Ä–æ—Å: ${question}`);

	// –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
	for (let i = 0; i < args.length; i++) {
		const optionText = args[i];

		message.buttonRow().button({
			style: 'primary',
			text: `‚ñ∂Ô∏è ${optionText}`,
			// –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–¥—É—Ç –Ω–∞–º –≤ —Å–æ–±—ã—Ç–∏–∏ callbackQuery
			callbackData: JSON.stringify({pollId, option: i}),
		});
	}

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º id —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–ø—Ä–æ—Å–æ–º –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
	polls[pollId].messageId = await ctx.sdk.sendText(ctx.event.payload.chat.chatId, message);
});

sdk.addCommand('/pollend', (ctx) => {
	const pollId = parseInt(ctx.args);
	const poll = polls[pollId];

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π –æ–ø—Ä–æ—Å
	if (!poll) {
		return ctx.sdk.sendText(ctx.event.payload.chat.chatId, `–û–ø—Ä–æ—Å ${pollId} –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
	}

	// –ó–∞–≤–µ—Ä—à–∞—Ç—å –æ–ø—Ä–æ—Å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä
	if (poll.author !== ctx.event.payload.from.userId) {
		return ctx.sdk.sendText(ctx.event.payload.chat.chatId, `–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞!`);
	}

	// –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–ø—Ä–æ—Å
	delete polls[pollId];

	// –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø—Ä–æ—Å–æ–º -- –≤—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–æ–∫
	const message = new MessageBuilder()
		.text('üìä')
		.text(` [${pollId}] [–∑–∞–≤–µ—Ä—à–µ–Ω–æ] `)
		.formatText('bold', `–û–ø—Ä–æ—Å: ${poll.question}`);

	for (const option of poll.options) {
		message
			.formatText('none', '\n‚ñ∂Ô∏è ' + option.text + ': ')
			.formatText('italic', String(option.votes));
	}

	ctx.sdk.editText(ctx.event.payload.chat.chatId, poll.messageId, message);
});

// –û–±—Ä–∞—Ç–∞–±—ã–≤–∞–µ–º –Ω–∞–∂–∞–Ω–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤ –æ–ø—Ä–æ—Å–∞—Ö
// –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É, –∫–ª–∏–µ–Ω—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
// –∏ —Ä–∏—Å—É–µ—Ç —É –∫–ª–∏–∫–Ω—É—Ç–æ–π –∫–Ω–æ–ø–∫–∏ —Å–ø–∏–Ω–Ω–µ—Ä, –∞ —Å–µ—Ä–≤–µ—Ä —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–º —Å–æ–±—ã—Ç–∏–µ callbackQuery,
// –ø–µ—Ä–µ–¥–∞–≤–∞—è –ø–∞—Ä–∞–º–µ—Ç—Ä callbackData –∫–ª–∏–∫–Ω—É—Ç–æ–π –∫–Ω–æ–ø–∫–∏.
//
// –ß—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –∏ —É–±—Ä–∞—Ç—å —Å–ø–∏–Ω–µ—Ä, –Ω–∞–¥–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ –∑–∞–ø—Ä–æ—Å –Ω–∞
// –º–µ—Ç–æ–¥ [answerCallbackQuery](https://myteam.mail.ru/botapi/#/messages/get_messages_answerCallbackQuery).
//
// SDK —É–º–µ–µ—Ç —ç—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞ –Ω–∞—Å, –¥–ª—è —ç—Ç–æ–≥–æ –≤ —ç—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å `event.answer()`
// –ó–∞–¥–∞–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–∑–æ–≤–∞ –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é `event.replyData`. –¢–∞–∫ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
// –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∞–ª–µ—Ä—Ç –∏–ª–∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é
// —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
sdk.on('callbackQuery', (event) => {
	// –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–ª–∏ –µ–π –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–º–∞–Ω–¥—ã /poll
	const {pollId, option} = JSON.parse(event.payload.callbackData);
	const poll = polls[pollId];

	// –û–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
	if (!poll) {
		// –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ –ø–æ–∫–∞–∂–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∞–ª–µ—Ä—Ç —Å –æ—à–∏–±–∫–æ–π
		event.replyData.alert('–û—à–∏–±–∫–∞! –û–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
		// –û—Ç–≤–µ—á–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –Ω–∞ –∑–∞–ø—Ä–æ—Å callbackQuery
		return event.answer();
	}

	// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
	if (poll.usersVoted[event.payload.from.userId]) {
		event.replyData.alert('–û—à–∏–±–∫–∞! –í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –≤ —ç—Ç–æ–º –æ–ø—Ä–æ—Å–µ.');
		return event.answer();
	}

	// –ì–æ–ª–æ—Å—É–µ–º
	poll.options[option].votes++;
	poll.usersVoted[event.payload.from.userId] = true;

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–≤–æ–∞—Ç–µ–ª—é
	event.replyData.text('–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏!');
	event.answer();
});

// –í—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
sdk.on('error', (error) => {
	console.error(error);
});


// –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π
sdk.listen();
